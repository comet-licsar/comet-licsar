<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>licsar_framebatch.python.framecare &mdash; COMET LiCSAR  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            COMET LiCSAR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../wiki.html">LiCSAR Wiki (from gitlab)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Main LiCSAR Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../licsar_db/index.html">LiCSInfo db</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licsar_proc/index.html">LiCSAR proc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licsar_framebatch/index.html">LiCSAR Framebatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../daz/index.html">daz</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../licsar_proc/apidoc.html">LiCSAR proc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licsar_framebatch/apidoc.html">LiCSAR FrameBatch</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Further information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ciw.html">COMET InSAR Workshop Materials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cometmembers.html">COMET Members Information</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer comments and advices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">Notes about documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html#admin-or-dev-comments">Admin or dev comments</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">COMET LiCSAR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">licsar_framebatch.python.framecare</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for licsar_framebatch.python.framecare</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Mar 2020+ - Milan Lazecky</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">subp</span>
<span class="kn">import</span> <span class="nn">LiCSquery</span> <span class="k">as</span> <span class="nn">lq</span>
<span class="kn">from</span> <span class="nn">LiCSAR_misc</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.wkt</span> <span class="kn">import</span> <span class="n">loads</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">LiCSAR_lib.LiCSAR_misc</span> <span class="k">as</span> <span class="nn">misc</span>
<span class="kn">import</span> <span class="nn">s1data</span> <span class="k">as</span> <span class="nn">s1</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">gpd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">fiona</span><span class="o">.</span><span class="n">drvsupport</span><span class="o">.</span><span class="n">supported_drivers</span><span class="p">[</span><span class="s1">&#39;KML&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rw&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: cannot load KML support&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">rioxarray</span>

<span class="n">pubdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LiCSAR_public&#39;</span><span class="p">]</span>
<span class="n">procdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LiCSAR_procdir&#39;</span><span class="p">]</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># notes:</span>
<span class="sd"># this is how i imported burst db - first i converted them from sqlite3 to geojson</span>
<span class="sd"># then i did, in /gws/nopw/j04/nceo_geohazards_vol1/projects/LiCS/proc/current/burst_database/IW/sqlite:</span>

<span class="sd">import geopandas as gpd</span>
<span class="sd">import shapely</span>
<span class="sd">import time</span>
<span class="sd">import LiCSquery as lq</span>

<span class="sd">aa=gpd.read_file(&#39;burst_map.geojson&#39;)</span>
<span class="sd">aa=aa[aa.burst_id&gt;56099]</span>

<span class="sd">aa[&#39;geometry&#39;]=aa[&#39;geometry&#39;].convex_hull</span>

<span class="sd">def _to_2d(x, y, z):</span>
<span class="sd">    return tuple(filter(None, [x, y]))</span>

<span class="sd">aa[&#39;geometry&#39;] = aa[&#39;geometry&#39;].apply(lambda x: shapely.ops.transform(_to_2d, x))</span>

<span class="sd"># now it is ready to import to database:</span>
<span class="sd">for i,j in aa.iterrows():</span>
<span class="sd">    print(i)</span>
<span class="sd">    res = store_burst_geom(j[0], int(j[1][-1]), j[2], j[3], j[4][0], j[5].wkt)</span>
<span class="sd">    #time.sleep(0.25)</span>

<span class="sd">lon1=72.510</span>
<span class="sd">lon2=72.845</span>
<span class="sd">lat1=38.130</span>
<span class="sd">lat2=38.365</span>
<span class="sd">resol_m=30</span>
<span class="sd">frame=&#39;100A_05236_141313&#39;</span>
<span class="sd">sid=&#39;SAREZ&#39;</span>
<span class="sd">fc.subset_initialise_corners(frame, lon1, lon2, lat1, lat2, sid)</span>


<span class="sd">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="subset_initialise_corners"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.subset_initialise_corners">[docs]</a><span class="k">def</span> <span class="nf">subset_initialise_corners</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">is_volc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">resol_m</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This will initialise a subset given by corner lon/lat-s.</span>
<span class="sd">    The results will be stored in $LiCSAR_procdir/subsets</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        frame (str): frame ID,</span>
<span class="sd">        lon1, lon2 (float, float): corner longitudes,</span>
<span class="sd">        lat1, lat2 (float, float): corner latitudes,</span>
<span class="sd">        sid (str):  string ID (for volcano, use its volcano ID number)</span>
<span class="sd">        is_volc (bool): if true, it will set the output folder $LiCSAR_procdir/subsets/volc</span>
<span class="sd">        resol_m (float): output resolution in metres to have geocoding table ready in (note, RSLCs are anyway in full res)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_volc</span><span class="p">:</span>
        <span class="n">sidpath</span> <span class="o">=</span> <span class="s1">&#39;volc/&#39;</span><span class="o">+</span><span class="n">sid</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sidpath</span> <span class="o">=</span> <span class="n">sid</span>
    <span class="c1">#</span>
    <span class="n">resol</span><span class="o">=</span><span class="n">resol_m</span><span class="o">/</span><span class="mi">111111</span> <span class="c1">#0.00027</span>
    <span class="n">resol</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">resol</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="c1"># sort the coordinates</span>
    <span class="n">lon1</span><span class="p">,</span><span class="n">lon2</span><span class="o">=</span><span class="nb">sorted</span><span class="p">([</span><span class="n">lon1</span><span class="p">,</span><span class="n">lon2</span><span class="p">])</span>
    <span class="n">lat1</span><span class="p">,</span><span class="n">lat2</span><span class="o">=</span><span class="nb">sorted</span><span class="p">([</span><span class="n">lat1</span><span class="p">,</span><span class="n">lat2</span><span class="p">])</span>
    <span class="c1">#</span>
    <span class="n">track</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">framedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LiCSAR_procdir&#39;</span><span class="p">],</span><span class="n">track</span><span class="p">,</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">subsetdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LiCSAR_procdir&#39;</span><span class="p">],</span><span class="s1">&#39;subsets&#39;</span><span class="p">,</span><span class="n">sidpath</span><span class="p">,</span><span class="n">frame</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">subsetdir</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the subset directory exists. continuing anyway..&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">framedir</span><span class="p">,</span> <span class="s1">&#39;subsets&#39;</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">framedir</span><span class="p">,</span> <span class="s1">&#39;subsets&#39;</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="c1"># get median height</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;getting median height&#39;</span><span class="p">)</span>
    <span class="n">hgt</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LiCSAR_public&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">[:</span><span class="mi">3</span><span class="p">])),</span> <span class="n">frame</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">+</span><span class="s1">&#39;.geo.hgt.tif&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">=</span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">hgt</span><span class="p">)</span>
    <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">sortby</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
    <span class="n">medhgt</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span><span class="n">lon2</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">))</span><span class="o">.</span><span class="n">median</span><span class="p">()))</span>
    <span class="c1">#medhgt=round(float(a.sel(x=(lon1,lon2), y=(lat1, lat2), method=&#39;nearest&#39;).median()))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... as </span><span class="si">{}</span><span class="s1"> m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">medhgt</span><span class="p">)))</span>
    <span class="c1">#</span>
    <span class="c1"># running the clipping in init-only mode</span>
    <span class="n">clipcmd</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="n">framedir</span><span class="o">+</span><span class="s2">&quot;; &quot;</span>
    <span class="n">clipcmd</span> <span class="o">=</span> <span class="n">clipcmd</span> <span class="o">+</span> <span class="s2">&quot;clip_slc.sh &quot;</span><span class="o">+</span><span class="n">subsetdir</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lon1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lon2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span>
    <span class="n">clipcmd</span> <span class="o">=</span>     <span class="n">clipcmd</span>   <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span>
    <span class="n">clipcmd</span> <span class="o">=</span>     <span class="n">clipcmd</span>   <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">medhgt</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">resol</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; 0 1&quot;</span>
    <span class="c1">#</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;initializing the subset&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">framedir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">clipcmd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">clipcmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">subsetdir</span><span class="p">):</span>
        <span class="n">subsetlink</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">framedir</span><span class="p">,</span> <span class="s1">&#39;subsets&#39;</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">subsetlink</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">subsetdir</span><span class="p">,</span> <span class="n">subsetlink</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some error occurred and the output dir was not created&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="subset_initialise_centre_coords"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.subset_initialise_centre_coords">[docs]</a><span class="k">def</span> <span class="nf">subset_initialise_centre_coords</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">clon</span><span class="p">,</span> <span class="n">clat</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">is_volc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">radius</span> <span class="o">=</span> <span class="mi">25</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">resol_m</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This will initialise a subset given by centre lon/lat and radius in km.</span>
<span class="sd">    The results will be stored in \$LiCSAR_procdir/subsets</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        frame (str): frame ID,</span>
<span class="sd">        clon (float): centre longitude,</span>
<span class="sd">        clat (float): centre latitude,</span>
<span class="sd">        sid (str):  string ID (for volcano, use its volcano ID number)</span>
<span class="sd">        is_volc (bool): if true, it will set the output folder \$LiCSAR_procdir/subsets/volc</span>
<span class="sd">        radius (float): radius (half of the diameter) of the subset scene, in km</span>
<span class="sd">        resol_m (float): output resolution in metres to have geocoding table ready in (note, RSLCs are anyway in full res)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># BASICS</span>
    <span class="n">radius_deg</span><span class="o">=</span><span class="n">radius_km</span><span class="o">/</span><span class="mi">111</span>
    <span class="n">lon1</span><span class="o">=</span><span class="n">lon</span><span class="o">-</span><span class="n">radius_deg</span>
    <span class="n">lon2</span><span class="o">=</span><span class="n">lon</span><span class="o">+</span><span class="n">radius_deg</span>
    <span class="n">lat1</span><span class="o">=</span><span class="n">lat</span><span class="o">-</span><span class="n">radius_deg</span>
    <span class="n">lat2</span><span class="o">=</span><span class="n">lat</span><span class="o">+</span><span class="n">radius_deg</span>
    <span class="n">subset_initialise_corners</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">is_volc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">resol_m</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">check_and_fix_burst</span><span class="p">(</span><span class="n">mburst</span><span class="p">,</span> <span class="n">framebursts</span><span class="p">):</span>
    <span class="c1"># to get mbursts of a zip file, e.g.:</span>
    <span class="c1"># frame = &#39;...&#39;</span>
    <span class="c1"># filename = &#39;S1A_IW_SLC__1SDV_20210429T114802_20210429T114829_037665_047199_F24F.zip&#39;</span>
    <span class="c1"># mbursts = fc.lq.sqlout2list(fc.lq.get_bursts_in_file(filename))</span>
    <span class="c1"># framebursts = fc.lq.sqlout2list(fc.lq.get_bidtanxs_in_frame(frame))</span>
    <span class="c1"># for mburst in mbursts: fc.check_and_fix_burst(mburst, framebursts)</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">mburst</span> <span class="ow">in</span> <span class="n">framebursts</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">changed</span>
    <span class="n">tr</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mburst</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">iw</span><span class="o">=</span><span class="n">mburst</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">tanx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mburst</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">fburst</span> <span class="ow">in</span> <span class="n">framebursts</span><span class="p">:</span>
        <span class="n">iwf</span><span class="o">=</span><span class="n">fburst</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">iwf</span> <span class="o">==</span> <span class="n">iw</span><span class="p">:</span>
            <span class="n">tanxf</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">fburst</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
            <span class="c1"># checking in a &#39;relaxed&#39; tolerance (0.8 s)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tanx</span> <span class="o">-</span> <span class="n">tanxf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="c1"># just to make sure they are both of the same pass..</span>
                <span class="k">if</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_orbdir_from_bidtanx</span><span class="p">(</span><span class="n">fburst</span><span class="p">)</span> <span class="o">==</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_orbdir_from_bidtanx</span><span class="p">(</span><span class="n">mburst</span><span class="p">):</span>
                    <span class="c1"># check if their geometries overlap</span>
                    <span class="n">fb_gpd</span> <span class="o">=</span> <span class="n">bursts2geopandas</span><span class="p">([</span><span class="n">fburst</span><span class="p">])</span>
                    <span class="n">mb_gpd</span> <span class="o">=</span> <span class="n">bursts2geopandas</span><span class="p">([</span><span class="n">mburst</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">fb_gpd</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">mb_gpd</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;we (very) probably found a cross-defined burst. fixing/merging to one&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">mburst</span><span class="o">+</span><span class="s1">&#39; -&gt; &#39;</span><span class="o">+</span><span class="n">fburst</span><span class="p">)</span>
                        <span class="n">lq</span><span class="o">.</span><span class="n">rename_burst</span><span class="p">(</span><span class="n">mburst</span><span class="p">,</span> <span class="n">fburst</span><span class="p">)</span>
                        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">changed</span>



<span class="k">def</span> <span class="nf">check_and_fix_all_bursts_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="s1">&#39;2014-10-01&#39;</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">framefiles</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_frame_files_period</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">framebursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_bidtanxs_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
    <span class="n">fdates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">noch</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">framefile</span> <span class="ow">in</span> <span class="n">framefiles</span><span class="p">:</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">framefile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.zip&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;checking &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">mbursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_file</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="c1"># visual check</span>
        <span class="c1"># from matplotlib import pyplot as plt</span>
        <span class="c1"># bursts_gpd = bursts2geopandas(mbursts)</span>
        <span class="c1"># frame_gpd = bursts2geopandas(framebursts)</span>
        <span class="c1"># bursts_gpd.plot()</span>
        <span class="c1"># frame_gpd.plot()</span>
        <span class="c1"># plt.show()</span>

        <span class="k">for</span> <span class="n">mburst</span> <span class="ow">in</span> <span class="n">mbursts</span><span class="p">:</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="n">check_and_fix_burst</span><span class="p">(</span><span class="n">mburst</span><span class="p">,</span> <span class="n">framebursts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                <span class="n">noch</span> <span class="o">=</span> <span class="n">noch</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">fdate</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">25</span><span class="p">]</span>
                <span class="n">fdates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fdate</span><span class="p">)</span>
    <span class="n">fdates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fdates</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;additionally checking only burst ids of similar tracks&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(same orbit pass direction, relorb+-1)&#39;</span><span class="p">)</span>
    <span class="c1">#trackid = frame[:4]</span>
    <span class="c1">#for fburst in framebursts:</span>
    <span class="n">track</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#int(fburst.split(&#39;_&#39;)[0])</span>
    <span class="k">for</span> <span class="n">cant</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="o">+</span><span class="mi">1</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="n">cant</span> <span class="o">==</span> <span class="s1">&#39;176&#39;</span><span class="p">:</span>
            <span class="n">cant</span> <span class="o">=</span> <span class="s1">&#39;001&#39;</span>
        <span class="k">if</span> <span class="n">cant</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
            <span class="n">cant</span> <span class="o">=</span> <span class="s1">&#39;175&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cant</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cant</span> <span class="o">=</span> <span class="s1">&#39;00&#39;</span><span class="o">+</span><span class="n">cant</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cant</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">cant</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="n">cant</span>
        <span class="n">trackid</span> <span class="o">=</span> <span class="n">cant</span><span class="o">+</span><span class="n">frame</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1">#canfburst = str(cant)+&#39;_&#39;+fburst.split(&#39;_&#39;)[1]+&#39;_&#39;+fburst.split(&#39;_&#39;)[2]</span>
        <span class="n">canfbursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bidtanxs_in_track</span><span class="p">(</span><span class="n">trackid</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">canfbursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">canfbursts</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">canfburst</span> <span class="ow">in</span> <span class="n">canfbursts</span><span class="p">:</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="n">check_and_fix_burst</span><span class="p">(</span><span class="n">canfburst</span><span class="p">,</span> <span class="n">framebursts</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                    <span class="n">noch</span> <span class="o">=</span> <span class="n">noch</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no bursts in the trackid &#39;</span><span class="o">+</span><span class="n">trackid</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">noch</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; burst definitions changed to fit the frame burst IDs&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">noch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;you may want to check following epochs:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fdate</span> <span class="ow">in</span> <span class="n">fdates</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;frame </span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">fdate</span><span class="p">))</span>
            <span class="c1">#print(&#39;remove_from_lics.sh {0} {1}&#39;.format(frame, fdate))</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">check these frames:</span>
<span class="sd">[&#39;149D_05278_131313&#39;, &#39;150D_05107_131313&#39;, &#39;150D_05306_131313&#39;, &#39;151D_05241_131313&#39;]</span>
<span class="sd">[&#39;149D_05425_060707&#39;, &#39;150D_05306_131313&#39;, &#39;150D_05505_131313&#39;, &#39;151D_05440_131313&#39;]</span>
<span class="sd">[&#39;149D_05278_131313&#39;, &#39;150D_05107_131313&#39;, &#39;150D_05306_131313&#39;, &#39;151D_05241_131313&#39;]</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">check_and_fix_all_files_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="s1">&#39;2014-10-01&#39;</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_frame_files_period</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">only_file_title</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lenf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lenf</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;] checking file &#39;</span><span class="o">+</span><span class="n">f</span><span class="p">)</span>
        <span class="n">check_bursts_in_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_and_fix_burst_supershifts_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">viewerror</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">frame_wkt</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">geom_from_polygs2geom</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">framepoly</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">frame_wkt</span><span class="p">)</span>
    <span class="n">framepoly_gpd</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">framepoly</span><span class="p">)</span>
    <span class="n">frame_bursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_bidtanxs_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
    <span class="n">fgpd</span> <span class="o">=</span> <span class="n">bursts2geopandas</span><span class="p">(</span><span class="n">frame_bursts</span><span class="p">)</span>
    <span class="c1">#b1 = fgpd.iloc[0]</span>
    <span class="c1"># 4.5 degrees in WGS-84 are approx 500 km - that should be enough to compare from the frame polygon centroid</span>
    <span class="n">cluster1</span> <span class="o">=</span> <span class="n">fgpd</span><span class="p">[</span><span class="n">fgpd</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">framepoly</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">4.5</span><span class="p">]</span>
    <span class="n">cluster2</span> <span class="o">=</span> <span class="n">fgpd</span><span class="p">[</span><span class="n">fgpd</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">framepoly</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">4.5</span><span class="p">]</span>
    <span class="c1">#polyid = lq.sqlout2list(lq.get_frame_polyid(frame))[0]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster2</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;here we are - two burst clusters!&#39;</span><span class="p">)</span>
        <span class="c1"># checking for the overlap anyways</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">framepoly</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">cluster1</span><span class="o">.</span><span class="n">unary_union</span><span class="p">):</span>
            <span class="n">badbursts_gpd</span> <span class="o">=</span> <span class="n">cluster1</span>
            <span class="n">goodbursts_gpd</span> <span class="o">=</span> <span class="n">cluster2</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">framepoly</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">cluster2</span><span class="o">.</span><span class="n">unary_union</span><span class="p">):</span>
            <span class="n">badbursts_gpd</span> <span class="o">=</span> <span class="n">cluster2</span>
            <span class="n">goodbursts_gpd</span> <span class="o">=</span> <span class="n">cluster1</span>
        <span class="k">if</span> <span class="n">viewerror</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;this is how the frame should look like:&#39;</span><span class="p">)</span>
            <span class="n">framepoly_gpd</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;and this is how it looks with the current burst definitions&#39;</span><span class="p">)</span>
            <span class="n">vis_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="c1">#print(&#39;trying to solve it - first find one file that has the burst as bad one&#39;)</span>
        <span class="n">check_and_fix_all_files_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        for bid in badbursts_gpd.burstID.values:</span>
<span class="sd">            filewithbidasbad = &#39;&#39;</span>
<span class="sd">            repeat = True</span>
<span class="sd">            filescheck = files.copy()</span>
<span class="sd">            while repeat:</span>
<span class="sd">                filewithbidasbad = &#39;&#39;</span>
<span class="sd">                for fileid in filescheck:</span>
<span class="sd">                    print(fileid)</span>
<span class="sd">                    is_bid_bad_there = check_bursts_in_file(fileid, badburstfind = bid)</span>
<span class="sd">                    if is_bid_bad_there == &#39;yes&#39;:</span>
<span class="sd">                        #now check if the file has some of the good bids, i.e. if it really is part of the frame</span>
<span class="sd">                        filebursts = lq.sqlout2list(lq.get_bursts_in_file(fileid))</span>
<span class="sd">                        for fbur in filebursts:</span>
<span class="sd">                            if fbur in goodbursts_gpd.burstID.values:</span>
<span class="sd">                                filewithbidasbad = fileid</span>
<span class="sd">                                break</span>
<span class="sd">                        if filewithbidasbad:</span>
<span class="sd">                            break</span>
<span class="sd">                if not filewithbidasbad:</span>
<span class="sd">                    print(&#39;no file with this burst as bad one, skipping&#39;)</span>
<span class="sd">                    repeat = False</span>
<span class="sd">                    continue</span>
<span class="sd">                #check_bursts_in_file(filewithbidasbad)</span>
<span class="sd">                lq.delete_file_from_db(filewithbidasbad, &#39;name&#39;)</span>
<span class="sd">                #print(&#39;debug&#39;)</span>
<span class="sd">                #print(filewithbidasbad)</span>
<span class="sd">                filepath = s1.get_neodc_path_images(filewithbidasbad, file_or_meta = True)[0]</span>
<span class="sd">                #this should regenerate the missing burst</span>
<span class="sd">                outchars = ingest_file_to_licsinfo(filepath)</span>
<span class="sd">                if outchars:</span>
<span class="sd">                    if outchars&lt;200:</span>
<span class="sd">                        print(&#39;did not help&#39;)</span>
<span class="sd">                        filescheck.remove(filewithbidasbad)</span>
<span class="sd">                        repeat = True</span>
<span class="sd">                    else:</span>
<span class="sd">                        print(&#39;YESSS, the reingested image created new bursts!!!!!&#39;)</span>
<span class="sd">                        repeat = False</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># now all the missing bursts probably exist, so let&#39;s try getting them in the frame overlap + check colat and exchange bids</span>
        <span class="n">minlon</span><span class="p">,</span> <span class="n">minlat</span><span class="p">,</span> <span class="n">maxlon</span><span class="p">,</span> <span class="n">maxlat</span> <span class="o">=</span> <span class="n">framepoly</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">track</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">burstcands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">relorb</span> <span class="ow">in</span> <span class="p">[</span><span class="n">track</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">track</span><span class="p">,</span> <span class="n">track</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">relorb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">relorb</span> <span class="o">=</span> <span class="mi">175</span>
            <span class="k">if</span> <span class="n">relorb</span> <span class="o">==</span> <span class="mi">176</span><span class="p">:</span> <span class="n">relorb</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">burstcandsT</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_polygon</span><span class="p">(</span><span class="n">minlon</span><span class="p">,</span> <span class="n">maxlon</span><span class="p">,</span> <span class="n">minlat</span><span class="p">,</span> <span class="n">maxlat</span><span class="p">,</span> <span class="n">relorb</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">burstcandsT</span><span class="p">:</span>
                <span class="n">burstcands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="c1"># now check their number etc.</span>
        <span class="c1">#and if all ok, use them instead of the bad ones - replace them</span>
        <span class="n">frame_bursts_to_change</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">frame_bursts</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">burstcands</span><span class="p">:</span>
                <span class="n">frame_bursts_to_change</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">burstcands</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_bursts_to_change</span><span class="p">)</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">burstcands</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR - not enough burst candidates - cannot exchange all bursts, cancelling&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#for swath in [1,2,3]:</span>
            <span class="n">frame_bursts_to_change_out</span> <span class="o">=</span> <span class="n">frame_bursts_to_change</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">frame_bursts_to_change</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;checking burst &#39;</span><span class="o">+</span><span class="n">fb</span><span class="p">)</span>
                <span class="n">sw</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">tanx</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">burstcands</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sw</span> <span class="o">==</span> <span class="n">bc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">tanx</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;exchanging </span><span class="si">{0}</span><span class="s1"> -&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="n">bc</span><span class="p">))</span>
                            <span class="n">lq</span><span class="o">.</span><span class="n">replace_bidtanx_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span>
                            <span class="n">frame_bursts_to_change_out</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fb</span><span class="p">)</span>
                            <span class="n">burstcands</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
                            <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_bursts_to_change_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR - not all frame bursts were replaced - the problematic bursts are returned:&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">frame_bursts_to_change_out</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;potential burst candidates were:&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">burstcands</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">frame_bursts_to_change_out</span><span class="p">,</span> <span class="n">burstcands</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the frame was corrected properly!&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">viewerror</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;see yourself&#39;</span><span class="p">)</span>
                    <span class="n">vis_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="c1">#return burstcands, frame_bursts_to_change</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bursts of this frame are ok&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># to get all files that are not participating in any frame</span>
<span class="c1">#sql = &quot;select f.name from files f where f.fid not in ( select fb.fid from files2bursts fb inner join polygs2bursts pb on fb.bid=pb.bid );&quot;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="k">def</span> <span class="nf">process_all_frames</span><span class="p">():</span>
    <span class="n">badtracks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">relorb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">175</span><span class="p">):</span> <span class="c1">#,175): #   86 need to do: 97-99</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;preparing track &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">relorb</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">allframes</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_frames_in_orbit</span><span class="p">(</span><span class="n">relorb</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error in relorb &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">relorb</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">badtracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relorb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">allframes</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>
            <span class="c1">#just change the function here</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1">#rc = check_and_fix_burst_supershifts_in_frame(frame, viewerror = False)</span>
                <span class="c1"># to process ALL FILES! (that are related to some any frame)</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">check_and_fix_burst_supershifts_in_frame_files</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">viewerror</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some error during processing frame &#39;</span><span class="o">+</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">badtracks</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">#to get files that are NOT in any frames - we have now over 250k of such files!</span>
<span class="sd">sql = &quot;select f.name from files f where f.fid not in ( select fb.fid from files2bursts fb inner join polygs2bursts pb on fb.bid=pb.bid );&quot;</span>
<span class="sd">nopolyfiles = lq.do_pd_query(sql)</span>
<span class="sd">i=0</span>
<span class="sd">filez = nopolyfiles.name.unique()</span>
<span class="sd">lenn = len(filez)</span>
<span class="sd">for fileid in filez:</span>
<span class="sd">    i=i+1</span>
<span class="sd">    print(&#39;[&#39;+str(i)+&#39;/&#39;+str(lenn)+&#39;]&#39;+fileid)</span>
<span class="sd">    lq.delete_file_from_db(fileid, col = &#39;name&#39;)</span>
<span class="sd">    filepath = s1.get_neodc_path_images(fileid, file_or_meta = True)[0]</span>
<span class="sd">    chars = ingest_file_to_licsinfo(filepath)</span>
<span class="sd">    print(chars)</span>
<span class="sd">    #time.sleep(2)</span>
<span class="sd">    #if not check_bursts_in_file(fileid):</span>
<span class="sd">    #    print(&#39;error in file &#39;+fileid)</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">check_and_fix_burst_supershifts_in_frame_files</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">viewerror</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">force_reingest</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="c1">#first get all files in frame and check them one by one:</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="s1">&#39;2014-10-01&#39;</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_frame_files_period</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">only_file_title</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fileid</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">force_reingest</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reingesting &#39;</span><span class="o">+</span><span class="n">fileid</span><span class="p">)</span>
            <span class="n">reingest_file</span><span class="p">(</span><span class="n">fileid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_bursts_in_file</span><span class="p">(</span><span class="n">fileid</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error in file &#39;</span><span class="o">+</span><span class="n">fileid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">viewerror</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;see yourself the current situation&#39;</span><span class="p">)</span>
                    <span class="n">bursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_file</span><span class="p">(</span><span class="n">fileid</span><span class="p">))</span>
                    <span class="n">vis_bidtanxs</span><span class="p">(</span><span class="n">bursts</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">reingest_all_files_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="s1">&#39;2014-10-01&#39;</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_frame_files_period</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">only_file_title</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fileid</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">reingest_file</span><span class="p">(</span><span class="n">fileid</span><span class="p">)</span>


<div class="viewcode-block" id="vis_file"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.vis_file">[docs]</a><span class="k">def</span> <span class="nf">vis_file</span><span class="p">(</span><span class="n">fileid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Visualize bursts of given file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fbursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_file</span><span class="p">(</span><span class="n">fileid</span><span class="p">)</span>
    <span class="n">fbursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">fbursts</span><span class="p">)</span>
    <span class="c1">#filegpd = bursts2geopandas(fbursts)</span>
    <span class="n">vis_bidtanxs</span><span class="p">(</span><span class="n">fbursts</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">check_bursts_in_file</span><span class="p">(</span><span class="n">fileid</span> <span class="o">=</span> <span class="s1">&#39;S1A_IW_SLC__1SDV_20210908T235238_20210908T235305_039597_04AE3C_4CA7&#39;</span><span class="p">,</span> <span class="n">badburstfind</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">autocorrect</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">fbursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_file</span><span class="p">(</span><span class="n">fileid</span><span class="p">)</span>
    <span class="n">fbursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">fbursts</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fbursts</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no bursts found for this file. trying to reingest it&#39;</span><span class="p">)</span>
        <span class="n">ingest_file_to_licsinfo</span><span class="p">(</span><span class="n">fileid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">filegpd</span> <span class="o">=</span> <span class="n">bursts2geopandas</span><span class="p">(</span><span class="n">fbursts</span><span class="p">)</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">filegpd</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># not perfect solution - there can be more than 2 clusters!!!!!!</span>
    <span class="c1"># but now, just removing and reingesting the file should help, anyway</span>
    <span class="c1"># 4.5 degrees in WGS-84 are approx 500 km - that should be enough..</span>
    <span class="n">cluster1</span> <span class="o">=</span> <span class="n">filegpd</span><span class="p">[</span><span class="n">filegpd</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">b1</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">4.5</span><span class="p">]</span>
    <span class="n">cluster2</span> <span class="o">=</span> <span class="n">filegpd</span><span class="p">[</span><span class="n">filegpd</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">b1</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">4.5</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster2</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;here we are - two burst clusters!&#39;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">get_info_pd</span><span class="p">(</span><span class="n">fileid</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filepoly</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">footprint</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some error loading footprint from scihub&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(making sure things work fine - reingesting this file)&#39;</span><span class="p">)</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">get_neodc_path_images</span><span class="p">(</span><span class="n">fileid</span><span class="p">,</span> <span class="n">file_or_meta</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="n">ingest_file_to_licsinfo</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filepoly</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">cluster1</span><span class="o">.</span><span class="n">unary_union</span><span class="p">):</span>
            <span class="n">badbursts_gpd</span> <span class="o">=</span> <span class="n">cluster1</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">filepoly</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">cluster2</span><span class="o">.</span><span class="n">unary_union</span><span class="p">):</span>
            <span class="n">badbursts_gpd</span> <span class="o">=</span> <span class="n">cluster2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;weird - both clusters overlap with the original file&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(making sure things work fine - reingesting this file)&#39;</span><span class="p">)</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">get_neodc_path_images</span><span class="p">(</span><span class="n">fileid</span><span class="p">,</span> <span class="n">file_or_meta</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="n">ingest_file_to_licsinfo</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">badburstfind</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">badburstfind</span> <span class="ow">in</span> <span class="n">badbursts_gpd</span><span class="o">.</span><span class="n">burstID</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;this burst is indeed in badbursts&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;yes&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;no&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">autocorrect</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">badbursts_gpd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allremoved</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">bid</span> <span class="ow">in</span> <span class="n">badbursts_gpd</span><span class="o">.</span><span class="n">burstID</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">frames</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_frames_with_burst</span><span class="p">(</span><span class="n">bid</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;checking &#39;</span><span class="o">+</span><span class="n">bid</span><span class="p">)</span>
                <span class="c1">#print(frames)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no frame is using this burst ID. as it is a bad burst, will remove it now, including files that use it&#39;</span><span class="p">)</span>
                    <span class="n">files2remove</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_filenames_from_burst</span><span class="p">(</span><span class="n">bid</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removing and reingesting file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files2remove</span><span class="p">))))</span>
                    <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">files2remove</span><span class="p">:</span>
                        <span class="n">lq</span><span class="o">.</span><span class="n">delete_file_from_db</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
                        <span class="n">filepath</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">get_neodc_path_images</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">file_or_meta</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">chars</span> <span class="o">=</span> <span class="n">ingest_file_to_licsinfo</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removing the bad burst &#39;</span><span class="o">+</span><span class="n">bid</span><span class="p">)</span>
                    <span class="n">rc</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">delete_burst_from_db</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#print(&#39;this burst is used in following frame(s):&#39;)</span>
                    <span class="c1">#print(frames)</span>
                    <span class="n">allremoved</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># ye.. or better append and remove dup. but who cares..</span>
                    <span class="n">badframes</span> <span class="o">=</span> <span class="n">frames</span>
            <span class="k">if</span> <span class="n">allremoved</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bad bursts are cleaned! reingesting the file&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;not all bad bursts removed from the database - but reingesting the file to fix it&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOME of frames still using a bad burst:&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">badframes</span><span class="p">)</span>
            <span class="n">lq</span><span class="o">.</span><span class="n">delete_file_from_db</span><span class="p">(</span><span class="n">fileid</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">get_neodc_path_images</span><span class="p">(</span><span class="n">fileid</span><span class="p">,</span> <span class="n">file_or_meta</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="n">ingest_file_to_licsinfo</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bursts of this file are ok&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">filez=filez[4514:]</span>
<span class="sd">lenn = len(filez)</span>
<span class="sd">i=0</span>
<span class="sd">badones = []</span>
<span class="sd">for fileid in filez.name.values:</span>
<span class="sd">    i=i+1</span>
<span class="sd">    print(&#39;[&#39;+str(i)+&#39;/&#39;+str(lenn)+&#39;] &#39;+fileid)</span>
<span class="sd">    if &#39;IW&#39; in fileid:</span>
<span class="sd">        try:</span>
<span class="sd">            reingest_file(fileid)</span>
<span class="sd">        except:</span>
<span class="sd">            print(&#39;error with &#39;+fileid)</span>
<span class="sd">            badones.append(fileid)</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    time.sleep(5)</span>
<span class="sd">    if not check_bursts_in_file(fileid):</span>
<span class="sd">        print(&#39;error in file &#39;+fileid)</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">reingest_file</span><span class="p">(</span><span class="n">fileid</span><span class="p">):</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">delete_file_from_db</span><span class="p">(</span><span class="n">fileid</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="n">chars</span> <span class="o">=</span> <span class="n">ingest_file_to_licsinfo</span><span class="p">(</span><span class="n">fileid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chars</span>


<div class="viewcode-block" id="ingest_file_to_licsinfo"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.ingest_file_to_licsinfo">[docs]</a><span class="k">def</span> <span class="nf">ingest_file_to_licsinfo</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">isfullpath</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Will ingest a S1 SLC zip file to the LiCSInfo database.</span>
<span class="sd">    If filepath is only filename, it will try find this file in neodc or LiCSAR_SLC&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isfullpath</span><span class="p">:</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">get_neodc_path_images</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">file_or_meta</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LiCSAR_SLC&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR - this file does not exist&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">aaaa</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;arch2DB.py&#39;</span><span class="p">,</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span><span class="n">filepath</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#cmd = &#39;arch2DB.py -f {} &gt;/dev/null 2&gt;/dev/null&#39;.format(filepath)</span>
        <span class="c1">#cmd = &#39;arch2DB.py -f {}&#39;.format(filepath)</span>
        <span class="c1">#rc = os.system(cmd)</span>
        <span class="n">aaaa</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;arch2DB.py&#39;</span><span class="p">,</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span><span class="n">filepath</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">aaaa</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_bidtanxs_from_xy"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.get_bidtanxs_from_xy">[docs]</a><span class="k">def</span> <span class="nf">get_bidtanxs_from_xy</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">relorb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">swath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets bursts in given coordinates (and optionally in given track or swath)&quot;&quot;&quot;</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_xy</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">relorb</span><span class="p">,</span><span class="n">swath</span><span class="p">,</span><span class="n">tol</span><span class="p">)</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">bursts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bursts</span></div>


<div class="viewcode-block" id="get_bidtanxs_from_xy_file"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.get_bidtanxs_from_xy_file">[docs]</a><span class="k">def</span> <span class="nf">get_bidtanxs_from_xy_file</span><span class="p">(</span><span class="n">intxt</span><span class="p">,</span> <span class="n">relorb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets bursts in polygon given by the xy text file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intxt</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR, the file does not exist&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">lonlat</span> <span class="o">=</span> <span class="n">load_xy</span><span class="p">(</span><span class="n">intxt</span><span class="p">)</span>
    <span class="n">bidtanxs</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_polygon</span><span class="p">(</span><span class="n">lonlat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">lonlat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">lonlat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">lonlat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">relorb</span> <span class="o">=</span> <span class="n">relorb</span><span class="p">)</span>
    <span class="n">bidtanxs</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;check the bursts, e.g. export_bidtanxs_to_kml&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bidtanxs</span></div>


<div class="viewcode-block" id="make_bperp_file"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.make_bperp_file">[docs]</a><span class="k">def</span> <span class="nf">make_bperp_file</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">bperp_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates baselines file for given frame, by requesting info from ASF&quot;&quot;&quot;</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="n">get_master</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">asfilenames</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mid</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">mid</span><span class="o">=</span><span class="n">mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bpd</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">get_bperps_asf</span><span class="p">(</span><span class="n">mid</span><span class="p">)</span>
    <span class="n">bpd</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">bperp_file</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">get_master</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">asfilenames</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">asdate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">asdatetime</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">metafile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metafile</span><span class="p">:</span>
        <span class="n">track</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">metafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pubdir</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">frame</span><span class="p">,</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span><span class="s1">&#39;metadata.txt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metafile</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;frame </span><span class="si">{}</span><span class="s1"> is not initialised&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">grep1line</span><span class="p">(</span><span class="s1">&#39;master&#39;</span><span class="p">,</span><span class="n">metafile</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">master</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error parsing information from metadata.txt&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">masterdate</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">asfilenames</span><span class="p">:</span>
        <span class="n">slcpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">procdir</span><span class="p">,</span> <span class="n">track</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="s1">&#39;SLC&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">masterdate</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">zipfiles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">zipfile</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">slcpath</span><span class="o">+</span><span class="s1">&#39;/S1*zip&#39;</span><span class="p">):</span>
                <span class="n">zipfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">zipfile</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">zipfiles</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error finding zip files in the frame SLC directory&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">asdate</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">masterdate</span>
        <span class="n">masterdate</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[:</span><span class="mi">4</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">asdatetime</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">masterdate</span>
        <span class="n">centime</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">grep1line</span><span class="p">(</span><span class="s1">&#39;center_time&#39;</span><span class="p">,</span><span class="n">metafile</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">centime</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error parsing center_time information from metadata.txt&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">centime</span> <span class="o">=</span> <span class="n">centime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">masterdate</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[:</span><span class="mi">4</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]),</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">centime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">centime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">centime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">masterdate</span>


<div class="viewcode-block" id="get_frame_master_s1ab"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.get_frame_master_s1ab">[docs]</a><span class="k">def</span> <span class="nf">get_frame_master_s1ab</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">metafile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Gets information if the reference epoch of given frame is S1 &#39;A&#39; or &#39;B&#39;.</span>
<span class="sd">    Args:</span>
<span class="sd">        frame (str)</span>
<span class="sd">        metafile (str): if None, it will identify it on LiCSAR_public</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metafile</span><span class="p">:</span>
        <span class="n">metafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LiCSAR_public&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="p">),</span> <span class="n">frame</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata.txt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metafile</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;metadata file does not exist for frame &#39;</span><span class="o">+</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;X&#39;</span>
    <span class="n">primepoch</span> <span class="o">=</span> <span class="n">grep1line</span><span class="p">(</span><span class="s1">&#39;master=&#39;</span><span class="p">,</span><span class="n">metafile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">path_to_slcdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LiCSAR_procdir&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="p">),</span> <span class="n">frame</span><span class="p">,</span> <span class="s1">&#39;SLC&#39;</span><span class="p">,</span> <span class="n">primepoch</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path_to_slcdir</span><span class="o">+</span><span class="s1">&#39;/S1*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error getting the value for frame &#39;</span><span class="o">+</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="vis_aoi"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.vis_aoi">[docs]</a><span class="k">def</span> <span class="nf">vis_aoi</span><span class="p">(</span><span class="n">aoi</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;to visualize a polygon element (&#39;aoi&#39;)&quot;&quot;&quot;</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="s1">&#39;epsg:4326&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">aoi</span><span class="p">)</span><span class="o">==</span><span class="nb">list</span><span class="p">:</span>
        <span class="n">aoi_gpd</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">aoi</span><span class="p">)</span>
        <span class="c1">#for a in aoi:</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aoi_gpd</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">aoi</span><span class="p">])</span>
    <span class="c1"># load world borders for background</span>
    <span class="n">world</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">gpd</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;naturalearth_lowres&#39;</span><span class="p">))</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">aoi_gpd</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">aoi_gpd</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">bounds</span><span class="o">.</span><span class="n">minx</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">bounds</span><span class="o">.</span><span class="n">miny</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="vis_bidtanxs"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.vis_bidtanxs">[docs]</a><span class="k">def</span> <span class="nf">vis_bidtanxs</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize list of bursts (use bidtanx id, i.e. e.g. &#39;73_IW1_1234&#39;)&quot;&quot;&quot;</span>
    <span class="n">tovis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bid</span> <span class="ow">in</span> <span class="n">bidtanxs</span><span class="p">:</span>
        <span class="n">tovis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_polygon_from_bidtanx</span><span class="p">(</span><span class="n">bid</span><span class="p">))</span>
    <span class="n">vis_aoi</span><span class="p">(</span><span class="n">tovis</span><span class="p">)</span></div>


<div class="viewcode-block" id="vis_frame"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.vis_frame">[docs]</a><span class="k">def</span> <span class="nf">vis_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize frame ID&quot;&quot;&quot;</span>
    <span class="n">ai</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">bidtanxs</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span>
    <span class="n">vis_bidtanxs</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">extract_bursts_by_track</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">track</span><span class="p">):</span>
    <span class="n">newbids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bidtanx</span> <span class="ow">in</span> <span class="n">bidtanxs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bidtanx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="p">):</span>
            <span class="n">newbids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newbids</span>


<span class="k">def</span> <span class="nf">bursts2geopandas</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">merge</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_s1burst</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="c1"># in order to export to KML:</span>
    <span class="c1"># frame_gpd.to_file(&#39;~/kmls/&#39;+frame+&#39;.kml&#39;, driver=&#39;KML&#39;)</span>
    <span class="c1"># or to SHP:</span>
    <span class="c1"># frame_gpd.to_file(&#39;~/shps/&#39;+frame+&#39;.shp&#39;, driver=&#39;ESRI Shapefile&#39;)</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="s1">&#39;epsg:4326&#39;</span><span class="p">}</span>
    <span class="n">orbdir</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_orbdir_from_bidtanx</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">merge</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1">#if use_s1burst:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span><span class="o">==</span><span class="nb">list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bid</span> <span class="ow">in</span> <span class="n">bidtanxs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">use_s1burst</span><span class="p">:</span>
                    <span class="n">geometry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_s1b_geom_from_bidtanx</span><span class="p">(</span><span class="n">bid</span><span class="p">,</span> <span class="n">opass</span> <span class="o">=</span> <span class="n">orbdir</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">geometry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_polygon_from_bidtanx</span><span class="p">(</span><span class="n">bid</span><span class="p">))</span>
            <span class="n">df_name</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;burstID&#39;</span><span class="p">:</span> <span class="n">bidtanxs</span><span class="p">}</span>
            <span class="n">aoi_gpd</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">df_name</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_s1burst</span><span class="p">:</span>
                <span class="n">geometry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_s1b_geom_from_bidtanx</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">opass</span> <span class="o">=</span> <span class="n">orbdir</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">geometry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lq</span><span class="o">.</span><span class="n">get_polygon_from_bidtanx</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">))</span>
            <span class="n">aoi_gpd</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">geometry</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">generate_frame_polygon</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">orbdir</span><span class="p">)</span>
        <span class="n">framename</span> <span class="o">=</span> <span class="n">generate_frame_name</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span>
        <span class="c1">#aoi_gpd = gpd.GeoDataFrame(index=[0], crs=crs, geometry=[polygon])</span>
        <span class="n">aoi_gpd</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">({</span><span class="s1">&#39;frameID&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">framename</span><span class="p">]},</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">polygon</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">aoi_gpd</span>


<span class="k">def</span> <span class="nf">frame2geopandas</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">brute</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_s1burst</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">merge</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">use_s1burst</span><span class="p">:</span>
        <span class="n">bidtanxs</span><span class="o">=</span><span class="n">lq</span><span class="o">.</span><span class="n">get_bidtanxs_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">bidtanxs</span><span class="o">=</span><span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bursts2geopandas</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">merge</span> <span class="o">=</span> <span class="n">merge</span><span class="p">,</span> <span class="n">use_s1burst</span> <span class="o">=</span> <span class="n">use_s1burst</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">brute</span><span class="p">:</span>
        <span class="n">gpan</span> <span class="o">=</span> <span class="n">frame2geopandas_brute</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lq</span><span class="o">.</span><span class="n">is_in_polygs2geom</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;frame </span><span class="si">{}</span><span class="s1"> has no record in polygs2geom. Recreating&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
            <span class="n">gpan</span> <span class="o">=</span> <span class="n">frame2geopandas_brute</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#geometry = []</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="s1">&#39;epsg:4326&#39;</span><span class="p">}</span>
            <span class="n">wkt</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">geom_from_polygs2geom</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>
            <span class="c1">#gpan[&#39;frameID&#39;] = frame</span>
            <span class="n">gpan</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">({</span><span class="s1">&#39;frameID&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">frame</span><span class="p">]},</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">geom</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">gpan</span>


<span class="k">def</span> <span class="nf">frame2geopandas_brute</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">bidtanxs</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bidtanxs</span><span class="p">:</span>
        <span class="c1">#try it once again</span>
        <span class="n">bidtanxs</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bidtanxs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the frame &#39;</span><span class="o">+</span><span class="n">frame</span><span class="o">+</span><span class="s1">&#39; is not connected to any bursts. removing the frame&#39;</span><span class="p">)</span>
            <span class="n">lq</span><span class="o">.</span><span class="n">delete_frame_only</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="n">bidtanxs</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">newname</span> <span class="o">=</span> <span class="n">generate_frame_name</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some problem generating frame name from the bursts of frame: &#39;</span><span class="o">+</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1">#get the geopandas record</span>
    <span class="n">gpan</span> <span class="o">=</span> <span class="n">bursts2geopandas</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">merge</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gpan</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">newname</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">newname</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">newname</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="c1">#print(&#39;WARNING! This frame changed its definition&#39;)</span>
        <span class="c1">#print(&#39;{0} ---&gt; {1}&#39;.format(frame,newname))</span>
        <span class="c1">#print(&#39;framecare_rename.sh {0} {1}&#39;.format(frame,newname))</span>
        <span class="c1">#rename it in database</span>
        <span class="n">lq</span><span class="o">.</span><span class="n">rename_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">newname</span><span class="p">)</span>
        <span class="c1">#print(&#39;now we should do: rename_frame_main(frame,newname)&#39;)</span>
        <span class="n">rename_frame_main</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">newname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#keep the original name if bursts did not change..</span>
        <span class="n">gpan</span><span class="p">[</span><span class="s1">&#39;frameID&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">frame</span>
    <span class="c1">#outgpd = outgpd.append(gpan, ignore_index=True)</span>
    <span class="k">return</span> <span class="n">gpan</span>

<div class="viewcode-block" id="rename_frame_main"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.rename_frame_main">[docs]</a><span class="k">def</span> <span class="nf">rename_frame_main</span><span class="p">(</span><span class="n">framename</span><span class="p">,</span><span class="n">newname</span><span class="p">,</span> <span class="n">reportcsv</span> <span class="o">=</span> <span class="s1">&#39;/gws/nopw/j04/nceo_geohazards_vol1/public/LiCSAR_products/frameid_changes.txt&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    this function will physically rename a frame (and move folders etc.) - oh, but it doesn&#39;t touch the frame def in database! for this, use lq.rename_frame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">track</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">framename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">pubpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pubdir</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">framename</span><span class="p">)</span>
    <span class="n">procpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">procdir</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">framename</span><span class="p">)</span>
    <span class="n">newpubpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pubdir</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">newname</span><span class="p">)</span>
    <span class="n">newprocpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">procdir</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">newname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pubpath</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">pubpath</span><span class="p">,</span> <span class="n">newpubpath</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fileext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.geo.E.tif&#39;</span><span class="p">,</span><span class="s1">&#39;.geo.N.tif&#39;</span><span class="p">,</span><span class="s1">&#39;.geo.hgt.tif&#39;</span><span class="p">,</span><span class="s1">&#39;.geo.U.tif&#39;</span><span class="p">,</span><span class="s1">&#39;-poly.txt&#39;</span><span class="p">]:</span>
            <span class="n">oldfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newpubpath</span><span class="p">,</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span><span class="n">framename</span><span class="o">+</span><span class="n">fileext</span><span class="p">)</span>
            <span class="n">newfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newpubpath</span><span class="p">,</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span><span class="n">newname</span><span class="o">+</span><span class="n">fileext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">oldfile</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">oldfile</span><span class="p">,</span><span class="n">newfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">procpath</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">procpath</span><span class="p">,</span> <span class="n">newprocpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newprocpath</span><span class="p">,</span><span class="n">framename</span><span class="o">+</span><span class="s1">&#39;-poly.txt&#39;</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newprocpath</span><span class="p">,</span><span class="n">framename</span><span class="o">+</span><span class="s1">&#39;-poly.txt&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;frame </span><span class="si">{0}</span><span class="s1"> renamed to </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">framename</span><span class="p">,</span><span class="n">newname</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">reportcsv</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">reportcsv</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;oldname,newname</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">reportcsv</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">,</span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">framename</span><span class="p">,</span> <span class="n">newname</span><span class="p">))</span></div>

<span class="k">def</span> <span class="nf">get_number_of_ifgs</span><span class="p">(</span><span class="n">framename</span><span class="p">):</span>
    <span class="n">pubdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LiCSAR_public&#39;</span><span class="p">]</span>
    <span class="n">track</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">framename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">pubpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pubdir</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">framename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pubpath</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">ifgspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pubpath</span><span class="p">,</span><span class="s1">&#39;interferograms&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ifgspath</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">filenumber</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob1</span><span class="p">(</span><span class="n">ifgspath</span><span class="p">,</span><span class="s1">&#39;2???????_2???????&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">filenumber</span>


<span class="k">def</span> <span class="nf">get_epochs</span><span class="p">(</span><span class="n">framename</span><span class="p">,</span> <span class="n">return_mli_tifs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">pubdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LiCSAR_public&#39;</span><span class="p">]</span>
    <span class="n">track</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">framename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">pubpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pubdir</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">framename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pubpath</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">epochspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pubpath</span><span class="p">,</span><span class="s1">&#39;epochs&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">epochspath</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">return_mli_tifs</span><span class="p">:</span>
        <span class="c1">#this will return tif file paths</span>
        <span class="k">return</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">epochspath</span> <span class="o">+</span> <span class="s2">&quot;/**/*.geo.mli.tif&quot;</span><span class="p">,</span> <span class="n">recursive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">epochslist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob1</span><span class="p">(</span><span class="n">epochspath</span><span class="p">,</span><span class="s1">&#39;2???????&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">epochslist</span>


<span class="k">def</span> <span class="nf">get_ifg_list_pubdir</span><span class="p">(</span><span class="n">framename</span><span class="p">):</span>
    <span class="n">pubdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LiCSAR_public&#39;</span><span class="p">]</span>
    <span class="n">track</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">framename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">pubpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pubdir</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">framename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pubpath</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">ifgspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pubpath</span><span class="p">,</span><span class="s1">&#39;interferograms&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ifgspath</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">ifglist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob1</span><span class="p">(</span><span class="n">ifgspath</span><span class="p">,</span><span class="s1">&#39;2???????_2???????&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ifglist</span>


<span class="k">def</span> <span class="nf">get_epochs_from_ifg_list_pubdir</span><span class="p">(</span><span class="n">framename</span><span class="p">):</span>
    <span class="n">ifglist</span> <span class="o">=</span> <span class="n">get_ifg_list_pubdir</span><span class="p">(</span><span class="n">framename</span><span class="p">)</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ifglist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ifg</span> <span class="ow">in</span> <span class="n">ifglist</span><span class="p">:</span>
            <span class="n">epochs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ifg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">epochs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ifg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">export_frames_to_licsar_csv</span><span class="p">(</span><span class="n">framesgpd</span><span class="p">,</span> <span class="n">outcsv</span> <span class="o">=</span> <span class="s1">&#39;/gws/nopw/j04/nceo_geohazards_vol1/public/shared/frames/frames.csv&#39;</span><span class="p">,</span> <span class="n">store_zero</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="c1">#print(&#39;now we would export the frame to outcsv, including wkb&#39;)</span>
    <span class="c1"># this will update the csv, not rewrite it..</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outcsv</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outcsv</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;the_geom,frame,files,download,direction</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outcsv</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1">#extract needed information</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">framesgpd</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">framename</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;frameID&#39;</span><span class="p">]</span>
            <span class="n">track</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">framename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">download</span> <span class="o">=</span> <span class="s2">&quot;&lt;a href=&#39;http://gws-access.ceda.ac.uk/public/nceo_geohazards/LiCSAR_products/</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">/&#39; target=&#39;_blank&#39;&gt;Link&lt;a&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="p">),</span><span class="n">framename</span><span class="p">)</span>
            <span class="n">orbdir</span> <span class="o">=</span> <span class="n">framename</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">orbdir</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;Ascending&#39;</span>
            <span class="k">elif</span> <span class="n">orbdir</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;Descending&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wrong framename! Aborting&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="c1">#get number of files</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">get_number_of_ifgs</span><span class="p">(</span><span class="n">framename</span><span class="p">)</span>
            <span class="c1">#get geometrywkb</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wkb_hex</span>
            <span class="c1">#we do not want to export it in case of no files in public...:</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">store_zero</span><span class="p">)</span> <span class="ow">and</span> <span class="n">files</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">store_zero</span><span class="p">:</span>
                <span class="c1">#if frame already in csv file, remove its line and update by new files no.</span>
                <span class="k">if</span> <span class="n">misc</span><span class="o">.</span><span class="n">grep1line</span><span class="p">(</span><span class="n">framename</span><span class="p">,</span> <span class="n">outcsv</span><span class="p">):</span>
                    <span class="n">misc</span><span class="o">.</span><span class="n">sed_rmlinematch</span><span class="p">(</span><span class="n">framename</span><span class="p">,</span> <span class="n">outcsv</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">,</span><span class="si">{1}</span><span class="s1">,</span><span class="si">{2}</span><span class="s1">,</span><span class="si">{3}</span><span class="s1">,</span><span class="si">{4}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span> <span class="n">framename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">download</span><span class="p">,</span> <span class="n">direction</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">store_frame_geometry</span><span class="p">(</span><span class="n">framesgpd</span><span class="p">):</span>
    <span class="n">fileio_error</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">framesgpd</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">framename</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;frameID&#39;</span><span class="p">]</span>
        <span class="n">track</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">framename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wkt</span>
        <span class="c1">#update the xy file:</span>
        <span class="n">pubfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pubdir</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="p">),</span><span class="n">framename</span><span class="p">,</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span><span class="n">framename</span><span class="o">+</span><span class="s1">&#39;-poly.txt&#39;</span><span class="p">)</span>
        <span class="n">procfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">procdir</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="p">),</span><span class="n">framename</span><span class="p">,</span><span class="n">framename</span><span class="o">+</span><span class="s1">&#39;-poly.txt&#39;</span><span class="p">)</span>
        <span class="n">procframefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">procdir</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="p">),</span><span class="n">framename</span><span class="p">,</span><span class="s1">&#39;frame.xy&#39;</span><span class="p">)</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fileout</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pubfile</span><span class="p">,</span> <span class="n">procfile</span><span class="p">,</span> <span class="n">procframefile</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileout</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fileout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileout</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">fileio_error</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1">#print(&#39;warning, {0} could not have been generated&#39;.format(fileout))</span>
        <span class="c1">#update the database GIS table</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">store_frame_geometry</span><span class="p">(</span><span class="n">framename</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">export_geopandas_to_kml</span><span class="p">(</span><span class="n">gpan</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
    <span class="n">gpan</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;KML&#39;</span><span class="p">,</span> <span class="n">NameField</span><span class="o">=</span><span class="s1">&#39;frameID&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bursts_group_to_iws</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">):</span>
    <span class="n">iw1s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">iw2s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">iw3s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bidt</span> <span class="ow">in</span> <span class="n">bidtanxs</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;IW1&#39;</span> <span class="ow">in</span> <span class="n">bidt</span><span class="p">:</span>
            <span class="n">iw1s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bidt</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;IW2&#39;</span> <span class="ow">in</span> <span class="n">bidt</span><span class="p">:</span>
            <span class="n">iw2s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bidt</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;IW3&#39;</span> <span class="ow">in</span> <span class="n">bidt</span><span class="p">:</span>
            <span class="n">iw3s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bidt</span><span class="p">)</span>
    <span class="n">iw1s</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">iw2s</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">iw3s</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">iw1s</span><span class="p">,</span> <span class="n">iw2s</span><span class="p">,</span> <span class="n">iw3s</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">generate_frame_polygon</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">orbdir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">orbdir</span><span class="p">:</span>
        <span class="n">orbdir</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_orbdir_from_bidtanx</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">burstgpd</span> <span class="o">=</span> <span class="n">bursts2geopandas</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some error during bursts2geopandas, maybe mysql problem&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1">#unite bursts, but this will keep errors:</span>
    <span class="n">framegpd</span> <span class="o">=</span> <span class="n">burstgpd</span><span class="o">.</span><span class="n">unary_union</span>
    <span class="c1">#corrections based on:</span>
    <span class="c1"># https://gis.stackexchange.com/questions/277334/shapely-polygon-union-results-in-strange-artifacts-of-tiny-non-overlapping-area</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">0.025</span>
    <span class="n">tolsim</span> <span class="o">=</span> <span class="n">eps</span>
    <span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">JOIN_STYLE</span>
    <span class="n">framegpd</span> <span class="o">=</span> <span class="n">framegpd</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">join_style</span><span class="o">=</span><span class="n">JOIN_STYLE</span><span class="o">.</span><span class="n">mitre</span><span class="p">)</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">join_style</span><span class="o">=</span><span class="n">JOIN_STYLE</span><span class="o">.</span><span class="n">mitre</span><span class="p">)</span>
    <span class="n">framegpd</span> <span class="o">=</span> <span class="n">framegpd</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="n">tolsim</span><span class="p">)</span>
    <span class="c1">#maximal number of points should be 13!</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">framegpd</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">[:])</span><span class="o">&gt;</span><span class="mi">13</span><span class="p">:</span>
        <span class="n">tolsim</span> <span class="o">=</span> <span class="n">tolsim</span><span class="o">+</span><span class="mf">0.001</span>
        <span class="n">framegpd</span> <span class="o">=</span> <span class="n">framegpd</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="n">tolsim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">framegpd</span><span class="o">.</span><span class="n">exterior</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">generate_frame_polygon_old</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">orbdir</span><span class="p">):</span>
    <span class="p">[</span><span class="n">iw1s</span><span class="p">,</span> <span class="n">iw2s</span><span class="p">,</span> <span class="n">iw3s</span><span class="p">]</span> <span class="o">=</span> <span class="n">bursts_group_to_iws</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">orbdir</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
        <span class="c1">#print(&#39;not yet tested&#39;)</span>
        <span class="n">iwsmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">iwsmax</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">first_point_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">second_point_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">last_point</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">prelast_point</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">iwsmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">iwsmax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">first_point_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">second_point_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">last_point</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">prelast_point</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">minbids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">maxbids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iws</span> <span class="ow">in</span> <span class="p">[</span><span class="n">iw1s</span><span class="p">,</span> <span class="n">iw2s</span><span class="p">,</span> <span class="n">iw3s</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iws</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">minbids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iws</span><span class="p">[</span><span class="n">iwsmin</span><span class="p">])</span>
            <span class="n">maxbids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iws</span><span class="p">[</span><span class="n">iwsmax</span><span class="p">])</span>
    <span class="n">lons_poly</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">lats_poly</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">bid</span> <span class="ow">in</span> <span class="n">minbids</span><span class="p">:</span>
        <span class="n">bidpoly</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_polygon_from_bidtanx</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">bidpoly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pom</span> <span class="ow">in</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">x</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pom</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pom</span> <span class="ow">in</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">y</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pom</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">y</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="c1">#get two minimal points of lats</span>
        <span class="n">lats_poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">first_point_id</span><span class="p">])</span>
        <span class="n">lats_poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">second_point_id</span><span class="p">])</span>
        <span class="n">index_min0</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">first_point_id</span><span class="p">])</span>
        <span class="n">index_min1</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">second_point_id</span><span class="p">])</span>
            <span class="c1">#get lons that correspond to their lats</span>
        <span class="n">lons_poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index_min0</span><span class="p">])</span>
        <span class="n">lons_poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index_min1</span><span class="p">])</span>
    <span class="n">maxbids</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">bid</span> <span class="ow">in</span> <span class="n">maxbids</span><span class="p">:</span>
        <span class="n">bidpoly</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_polygon_from_bidtanx</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">bidpoly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pom</span> <span class="ow">in</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pom</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pom</span> <span class="ow">in</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pom</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">y</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="c1">#get two maximal points of lats</span>
        <span class="n">lats_poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">last_point</span><span class="p">])</span>
        <span class="n">lats_poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">prelast_point</span><span class="p">])</span>
        <span class="n">index_max0</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">last_point</span><span class="p">])</span>
        <span class="n">index_max1</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">prelast_point</span><span class="p">])</span>
        <span class="n">lons_poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index_max0</span><span class="p">])</span>
        <span class="n">lons_poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index_max1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Polygon</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lons_poly</span><span class="p">,</span> <span class="n">lats_poly</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">generate_frame_name</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">):</span>
    <span class="n">track</span> <span class="o">=</span> <span class="n">bidtanxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">orbdir</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_orbdir_from_bidtanx</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">polyhon</span> <span class="o">=</span> <span class="n">generate_frame_polygon</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">orbdir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">polyhon</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some error generating frame polygon - mysql access error?&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">lat_center</span> <span class="o">=</span> <span class="n">polyhon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">colat</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">get_colat10</span><span class="p">(</span><span class="n">lat_center</span><span class="p">)</span>
    <span class="c1">#print(colat)</span>
    <span class="n">polyid_track</span> <span class="o">=</span> <span class="s1">&#39;00&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="p">)</span><span class="o">+</span><span class="n">orbdir</span>
    <span class="n">polyid_track</span> <span class="o">=</span> <span class="n">polyid_track</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
    <span class="p">[</span><span class="n">iw1s</span><span class="p">,</span> <span class="n">iw2s</span><span class="p">,</span> <span class="n">iw3s</span><span class="p">]</span> <span class="o">=</span> <span class="n">bursts_group_to_iws</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span>
    <span class="n">iw1_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw1s</span><span class="p">));</span> <span class="n">iw2_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw2s</span><span class="p">));</span> <span class="n">iw3_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw3s</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iw1s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="n">iw1_str</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw1s</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iw2s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="n">iw2_str</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw2s</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iw3s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="n">iw3_str</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw3s</span><span class="p">))</span>
    <span class="n">polyid_colat10</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">colat</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span> <span class="n">polyid_colat10</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">colat</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span> <span class="n">polyid_colat10</span> <span class="o">=</span> <span class="s1">&#39;00&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">colat</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span> <span class="n">polyid_colat10</span> <span class="o">=</span> <span class="s1">&#39;000&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">colat</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="n">polyid_colat10</span> <span class="o">=</span> <span class="s1">&#39;0000&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span>
    <span class="n">polyid_name</span> <span class="o">=</span> <span class="n">polyid_track</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">polyid_colat10</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">iw1_str</span><span class="o">+</span><span class="n">iw2_str</span><span class="o">+</span><span class="n">iw3_str</span>
    <span class="k">return</span> <span class="n">polyid_name</span>

<div class="viewcode-block" id="generate_new_frame"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.generate_new_frame">[docs]</a><span class="k">def</span> <span class="nf">generate_new_frame</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span><span class="n">testonly</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">hicode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    hicode... use &#39;H&#39; for high resolution (1/5 multilook), or &#39;M&#39; for medium, i.e. 56 m</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#and now i can generate the new frame:</span>
    <span class="n">track</span> <span class="o">=</span> <span class="n">bidtanxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">orbdir</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_orbdir_from_bidtanx</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">polyhon</span> <span class="o">=</span> <span class="n">generate_frame_polygon</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">orbdir</span><span class="p">)</span>
    <span class="n">lat_center</span> <span class="o">=</span> <span class="n">polyhon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">colat</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">get_colat10</span><span class="p">(</span><span class="n">lat_center</span><span class="p">)</span>
    <span class="c1">#print(colat)</span>
    <span class="n">polyid_track</span> <span class="o">=</span> <span class="s1">&#39;00&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="p">)</span><span class="o">+</span><span class="n">orbdir</span>
    <span class="n">polyid_track</span> <span class="o">=</span> <span class="n">polyid_track</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
    <span class="p">[</span><span class="n">iw1s</span><span class="p">,</span> <span class="n">iw2s</span><span class="p">,</span> <span class="n">iw3s</span><span class="p">]</span> <span class="o">=</span> <span class="n">bursts_group_to_iws</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">)</span>
    <span class="n">iw1_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw1s</span><span class="p">));</span> <span class="n">iw2_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw2s</span><span class="p">));</span> <span class="n">iw3_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw3s</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iw1s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="n">iw1_str</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw1s</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iw2s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="n">iw2_str</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw2s</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iw3s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="n">iw3_str</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iw3s</span><span class="p">))</span>
    <span class="n">polyid_colat10</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">colat</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span> <span class="n">polyid_colat10</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">colat</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span> <span class="n">polyid_colat10</span> <span class="o">=</span> <span class="s1">&#39;00&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">colat</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span> <span class="n">polyid_colat10</span> <span class="o">=</span> <span class="s1">&#39;000&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">colat</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="n">polyid_colat10</span> <span class="o">=</span> <span class="s1">&#39;0000&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span>
    <span class="n">polyid_name</span> <span class="o">=</span> <span class="n">polyid_track</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">polyid_colat10</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">iw1_str</span><span class="o">+</span><span class="n">iw2_str</span><span class="o">+</span><span class="n">iw3_str</span>
    <span class="k">if</span> <span class="n">hicode</span><span class="p">:</span>
        <span class="n">polyid_name</span> <span class="o">=</span> <span class="n">polyid_name</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="n">hicode</span><span class="o">+</span><span class="n">polyid_name</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
    <span class="c1">#print(polyid_name)</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select count(*) from polygs where polyid_name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid_name</span><span class="p">)</span>
    <span class="n">polyid_exists</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">polyid_exists</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the polyid_name &#39;</span><span class="o">+</span> <span class="n">polyid_name</span> <span class="o">+</span><span class="s1">&#39; exists, skipping&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
        <span class="n">lats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NULL&#39;</span><span class="p">)</span>
        <span class="n">lons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NULL&#39;</span><span class="p">)</span>
    <span class="c1">#print(len(polyhon.exterior.coords.xy[1]))</span>
    <span class="c1"># removing last coordinate as this should be same as the first one</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polyhon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1">#lats.append(lat)</span>
        <span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">polyhon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">lons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">polyhon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="c1">#for lon in polyhon.exterior.coords.xy[0]:</span>
    <span class="c1">#    lons.append(lon)</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;select polyid from polygs order by polyid desc limit 1;&#39;</span>
    <span class="n">lastpolyid</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">polyid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastpolyid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;seems like first frame to ingest - ok&#39;</span><span class="p">)</span>
        <span class="n">polyid</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">inserted</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">name_old</span> <span class="o">=</span> <span class="s1">&#39;frame_&#39;</span><span class="o">+</span><span class="n">polyid_track</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_t&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">polyid_track</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span><span class="o">+</span><span class="s1">&#39;_1bidxxxxxx&#39;</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO polygs VALUES (</span><span class="si">{0}</span><span class="s2">, &#39;</span><span class="si">{1}</span><span class="s2">&#39;, &#39;</span><span class="si">{2}</span><span class="s2">&#39;, </span><span class="si">{3}</span><span class="s2">, </span><span class="si">{4}</span><span class="s2">, </span><span class="si">{5}</span><span class="s2">, </span><span class="si">{6}</span><span class="s2">, </span><span class="si">{7}</span><span class="s2">, </span><span class="si">{8}</span><span class="s2">, </span><span class="si">{9}</span><span class="s2">, </span><span class="si">{10}</span><span class="s2">, </span><span class="si">{11}</span><span class="s2">, &quot;</span>\
    <span class="s2">&quot;</span><span class="si">{12}</span><span class="s2">, </span><span class="si">{13}</span><span class="s2">, </span><span class="si">{14}</span><span class="s2">, </span><span class="si">{15}</span><span class="s2">, </span><span class="si">{16}</span><span class="s2">, </span><span class="si">{17}</span><span class="s2">, </span><span class="si">{18}</span><span class="s2">, </span><span class="si">{19}</span><span class="s2">, </span><span class="si">{20}</span><span class="s2">, </span><span class="si">{21}</span><span class="s2">, </span><span class="si">{22}</span><span class="s2">, </span><span class="si">{23}</span><span class="s2">, </span><span class="si">{24}</span><span class="s2">, </span><span class="si">{25}</span><span class="s2">, </span><span class="si">{26}</span><span class="s2">, </span><span class="si">{27}</span><span class="s2">, &quot;</span>\
    <span class="s2">&quot;</span><span class="si">{28}</span><span class="s2">, </span><span class="si">{29}</span><span class="s2">, </span><span class="si">{30}</span><span class="s2">, &#39;</span><span class="si">{31}</span><span class="s2">&#39;, </span><span class="si">{32}</span><span class="s2">, &#39;</span><span class="si">{33}</span><span class="s2">&#39;);&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>\
                       <span class="n">polyid</span><span class="p">,</span> <span class="n">polyid_name</span><span class="p">,</span> <span class="n">polyid_track</span><span class="p">,</span> <span class="n">polyid_colat10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iw1s</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">iw2s</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">iw3s</span><span class="p">),</span>\
                       <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>\
                       <span class="n">lats</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>\
                       <span class="n">lats</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>\
                       <span class="n">name_old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inserted</span><span class="p">)</span>
    <span class="c1">#print(sql)</span>
    <span class="c1">#return 0</span>
    <span class="k">if</span> <span class="n">testonly</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TEST ONLY&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;this command would be performed: &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bid_tanx</span> <span class="o">=</span> <span class="n">iw1s</span><span class="o">+</span><span class="n">iw2s</span><span class="o">+</span><span class="n">iw3s</span>
    <span class="k">for</span> <span class="n">bidtanx</span> <span class="ow">in</span> <span class="n">bid_tanx</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;select bid from bursts where bid_tanx=&quot;</span><span class="si">{}</span><span class="s1">&quot;;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="c1">#print(sql)</span>
        <span class="n">bid</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO polygs2bursts VALUES (</span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1">);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">,</span><span class="n">bid</span><span class="p">)</span>
        <span class="c1">#print(sql)</span>
        <span class="k">if</span> <span class="n">testonly</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">testonly</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;including to polyg2gis table&#39;</span><span class="p">)</span>
        <span class="n">gpan</span> <span class="o">=</span> <span class="n">frame2geopandas_brute</span><span class="p">(</span><span class="n">polyid_name</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">store_frame_geometry</span><span class="p">(</span><span class="n">gpan</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR STORING TO polyg2gis TABLE!!!&#39;</span><span class="p">)</span>
        <span class="c1">#else:</span>
        <span class="c1">#</span>
        <span class="c1">#actually the licsar csv should not contain this..</span>
        <span class="c1">#rc = export_frames_to_licsar_csv(gpan)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;generated new frame &#39;</span><span class="o">+</span><span class="n">polyid_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;you may do following now: &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;licsar_initiate_new_frame.sh &#39;</span><span class="o">+</span><span class="n">polyid_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hicode</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(but remember adding parameter -&#39;</span><span class="o">+</span><span class="n">hicode</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="c1">#delete_frame_commands(frame)</span>
    <span class="k">return</span> <span class="n">polyid_name</span></div>


<span class="k">def</span> <span class="nf">generate_frame_from_bursts_kml</span><span class="p">(</span><span class="n">inputkml</span><span class="p">):</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="n">load_bursts_from_kml</span><span class="p">(</span><span class="n">inputkml</span><span class="p">)</span>
    <span class="n">generate_new_frame</span><span class="p">(</span><span class="n">bursts</span><span class="p">,</span> <span class="n">testonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_bursts_from_txt</span><span class="p">(</span><span class="n">intxt</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">intxt</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">burst</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
        <span class="n">bursts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">burst</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">bursts</span>


<span class="k">def</span> <span class="nf">load_xy</span><span class="p">(</span><span class="n">intxt</span><span class="p">,</span> <span class="n">onlyminmax</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">intxt</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
        <span class="n">lon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">onlyminmax</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lon</span><span class="p">)],</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lat</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">load_bursts_from_kml</span><span class="p">(</span><span class="n">inputkml</span><span class="p">):</span>
    <span class="c1">#inputkml = &#39;/gws/nopw/j04/nceo_geohazards_vol2/LiCS/temp/insar_temp/frames_redef/kmls/test_146a.kml&#39;</span>
    <span class="n">newbursts</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">inputkml</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;KML&#39;</span><span class="p">)</span>
    <span class="n">newbursts</span> <span class="o">=</span> <span class="n">newbursts</span><span class="p">[</span><span class="n">newbursts</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">newbursts</span>



<span class="k">def</span> <span class="nf">export_bidtanxs_to_kml</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">outpath</span> <span class="o">=</span> <span class="s1">&#39;/gws/nopw/j04/nceo_geohazards_vol1/public/shared/test&#39;</span><span class="p">,</span> <span class="n">projname</span> <span class="o">=</span> <span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="n">merge</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="c1">#kmlout name will be auto_completed</span>
    <span class="n">bidtanxs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">bid</span> <span class="ow">in</span> <span class="n">bidtanxs</span><span class="p">:</span>
        <span class="n">tracks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#print(tracks)</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">track_bursts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bidtanx</span> <span class="ow">in</span> <span class="n">bidtanxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bidtanx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">track</span><span class="p">:</span>
                <span class="n">track_bursts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
        <span class="c1">#print(track_bursts)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">kmlout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">.kml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">projname</span><span class="p">,</span> <span class="n">track</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kmlout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.kml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">projname</span><span class="p">))</span>
        <span class="c1">#print(kmlout)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">kmlout</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">kmlout</span><span class="p">)</span>
        <span class="n">frame_gpd</span> <span class="o">=</span> <span class="n">bursts2geopandas</span><span class="p">(</span><span class="n">track_bursts</span><span class="p">,</span> <span class="n">merge</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;exporting to &#39;</span><span class="o">+</span><span class="n">kmlout</span><span class="p">)</span>
        <span class="n">frame_gpd</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">kmlout</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;KML&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">merge</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done. please edit the kmls - delete not wanted bursts, save and return&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="export_frame_to_kml"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.export_frame_to_kml">[docs]</a><span class="k">def</span> <span class="nf">export_frame_to_kml</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">outpath</span> <span class="o">=</span> <span class="s1">&#39;/gws/nopw/j04/nceo_geohazards_vol2/LiCS/temp/insar_temp/frames_redef/kmls&#39;</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Exports the frame polygon to kml. Currently only the uglier version (coarse burst polygons)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
    <span class="n">ai</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">bidtanxs</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span>
    <span class="n">export_bidtanxs_to_kml</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">projname</span> <span class="o">=</span> <span class="n">frame</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="n">merge</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">export_all_frames_to_framecsv</span><span class="p">(</span><span class="n">outcsv</span> <span class="o">=</span> <span class="s1">&#39;/gws/nopw/j04/nceo_geohazards_vol1/public/shared/frames/frames.csv&#39;</span><span class="p">,</span> <span class="n">store_zero</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">asc_gpd</span><span class="p">,</span> <span class="n">desc_gpd</span> <span class="o">=</span> <span class="n">get_all_frames</span><span class="p">()</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">export_frames_to_licsar_csv</span><span class="p">(</span><span class="n">asc_gpd</span><span class="p">,</span> <span class="n">outcsv</span><span class="p">,</span> <span class="n">store_zero</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">export_frames_to_licsar_csv</span><span class="p">(</span><span class="n">desc_gpd</span><span class="p">,</span> <span class="n">outcsv</span><span class="p">,</span> <span class="n">store_zero</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rc</span>


<span class="k">def</span> <span class="nf">get_satids_of_burst</span><span class="p">(</span><span class="n">burstid</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;S1A&#39;</span><span class="p">,</span><span class="s1">&#39;S1B&#39;</span><span class="p">]):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_filenames_from_burst</span><span class="p">(</span><span class="n">burstid</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>
    <span class="n">b</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
        <span class="n">satid</span><span class="o">=</span><span class="n">x</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">satid</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
            <span class="n">i</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">satid</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;sat_id&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">b</span>


<span class="k">def</span> <span class="nf">get_all_frames</span><span class="p">():</span>
    <span class="n">asc_gpd</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">geodataframe</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span>
    <span class="n">desc_gpd</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">geodataframe</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">175</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;preparing frames from track </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="c1">#descending:</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_frames_in_orbit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">frame2geopandas</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">desc_gpd</span> <span class="o">=</span> <span class="n">desc_gpd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="c1">#ascending</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_frames_in_orbit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">frame2geopandas</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">asc_gpd</span> <span class="o">=</span> <span class="n">asc_gpd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">asc_gpd</span><span class="p">,</span> <span class="n">desc_gpd</span>


<span class="k">def</span> <span class="nf">manual_check_master_files</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">master</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">):</span>
        <span class="n">masterdate</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">master</span><span class="p">,</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">masterdate</span><span class="o">=</span><span class="n">master</span>
    <span class="n">filelist</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_frame_files_date</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">masterdate</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filelist</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">filee</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
        <span class="n">fid</span><span class="o">=</span><span class="n">filee</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">brsts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_file</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="n">brsts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">brsts</span><span class="p">)</span>
        <span class="n">b</span><span class="o">=</span><span class="n">bursts2geopandas</span><span class="p">(</span><span class="n">brsts</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">filee</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">b</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;to fix the bad ones:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fullpath = ....&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lq.delete_file_from_db(fullpath)&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;os.system(&#39;arch2DB.py -f </span><span class="si">{}</span><span class="s2"> &gt;/dev/null 2&gt;/dev/null&#39;.format(fullpath))&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">export_all_frames_to_kmls</span><span class="p">(</span><span class="n">kmldirpath</span> <span class="o">=</span> <span class="s1">&#39;/gws/nopw/j04/nceo_geohazards_vol1/public/shared/frames/&#39;</span><span class="p">):</span>
    <span class="n">asc_gpd</span><span class="p">,</span> <span class="n">desc_gpd</span> <span class="o">=</span> <span class="n">get_all_frames</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmldirpath</span><span class="p">,</span><span class="s1">&#39;ascending.kml&#39;</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmldirpath</span><span class="p">,</span><span class="s1">&#39;ascending.kml&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmldirpath</span><span class="p">,</span><span class="s1">&#39;descending.kml&#39;</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmldirpath</span><span class="p">,</span><span class="s1">&#39;descending.kml&#39;</span><span class="p">))</span>
    
    <span class="n">export_geopandas_to_kml</span><span class="p">(</span><span class="n">asc_gpd</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmldirpath</span><span class="p">,</span><span class="s1">&#39;ascending.kml&#39;</span><span class="p">))</span>
    <span class="n">export_geopandas_to_kml</span><span class="p">(</span><span class="n">desc_gpd</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmldirpath</span><span class="p">,</span><span class="s1">&#39;descending.kml&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">delete_bursts</span><span class="p">(</span><span class="n">bidtanxs</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
         <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING, this will delete all bursts in the list FOREVER&#39;</span><span class="p">)</span>
         <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;if any frame still uses the burst ids, it will cancel their deletion&#39;</span><span class="p">)</span>
         <span class="k">return</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">bidtanx</span> <span class="ow">in</span> <span class="n">bidtanxs</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deleting burst &#39;</span><span class="o">+</span><span class="n">bidtanx</span><span class="p">)</span>
             <span class="k">try</span><span class="p">:</span>
                 <span class="n">rc</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">delete_burst_from_db</span><span class="p">(</span><span class="n">bidtanx</span><span class="p">)</span>
             <span class="k">except</span><span class="p">:</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some error occurred - cancelling&#39;</span><span class="p">)</span>
                 <span class="k">return</span>


<div class="viewcode-block" id="epoch_has_all_frame_bursts"><a class="viewcode-back" href="../../../licsar_framebatch/apidoc.html#licsar_framebatch.python.framecare.epoch_has_all_frame_bursts">[docs]</a><span class="k">def</span> <span class="nf">epoch_has_all_frame_bursts</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Checks if epoch contains all necessary bursts in frame definition.</span>
<span class="sd">    Needs to have the epoch already ingested in LiCSInfo database.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        epoch (dt.datetime.date, dt.datetime or str): epoch date (if str, should be as 20191120)</span>
<span class="sd">        frame (str): frame ID</span>
<span class="sd">    Returns:</span>
<span class="sd">        boolean: True means Yes, it has all bursts. False means it has missing bursts&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">):</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">burstlist</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bursts_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">mk_imag_lib</span> <span class="kn">import</span> <span class="n">check_master_bursts</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">check_master_bursts</span><span class="p">(</span> <span class="n">frame</span><span class="p">,</span> <span class="n">burstlist</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lq</span><span class="p">,</span> <span class="n">midnighterror</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<span class="k">def</span> <span class="nf">delete_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="c1">#print(&#39;cannot use this anymore, in CentOS7 - please contact admin to delete frame &#39;+frame)</span>
    <span class="c1">#return False</span>
    <span class="n">polyid</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_frame_polyid</span><span class="p">(</span><span class="n">frame</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">polyid</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error - is it correct frame??&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1">#cmd_mysql=&#39;mysql -h ..... licsar_batch &#39; # see lics_mysql.sh</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;setFrameInactive.py </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
    <span class="n">track</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf $LiCSAR_procdir/</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1"> $LiCSAR_public/</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track</span><span class="p">,</span><span class="n">frame</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sed -i &#39;/</span><span class="si">{}</span><span class="s2">/d&#39; /gws/nopw/j04/nceo_geohazards_vol1/public/shared/frames/frames.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sed -i &#39;/</span><span class="si">{}</span><span class="s2">/d&#39; /gws/nopw/j04/nceo_geohazards_vol1/public/LiCSAR_products/EQ/eqframes.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
    <span class="c1">#polyid = lq.get_frame_polyid(frame)[0][0]</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;delete from licsar_batch.polygs2master where polyid=</span><span class="si">{}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">#os.system(cmd_mysql+&#39; -e &quot;{}&quot;&#39;.format(sql))</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;delete from polygs2bursts where polyid=</span><span class="si">{}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;delete from esd where polyid=</span><span class="si">{}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error in deleting from esd table&#39;</span><span class="p">)</span>
    <span class="c1">#os.system(cmd_mysql+&#39; -e &quot;{}&quot;&#39;.format(sql))</span>
    <span class="n">frame_workaround</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
    <span class="n">frame_workaround</span> <span class="o">=</span> <span class="n">frame_workaround</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;update polygs set polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39; where polyid_name=&#39;</span><span class="si">{1}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame_workaround</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">#os.system(cmd_mysql+&#39; -e &quot;{}&quot;&#39;.format(sql))</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;delete from polygs where polygs.polyid_name=&#39;</span><span class="si">{}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame_workaround</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">#rc = os.system(cmd_mysql+&#39; -e &quot;{}&quot; 2&gt;/dev/null&#39;.format(sql))</span>
    <span class="c1">#if rc != 0:</span>
    <span class="c1">#    print(&#39;WARNING: the frame was only partially removed. But it should not appear in processing&#39;)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the frame </span><span class="si">{}</span><span class="s1"> has been removed, associated files purged&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">delete_frame_commands</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;setFrameInactive.py </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
    <span class="n">track</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rm -rf $LiCSAR_procdir/</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1"> $LiCSAR_public/</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track</span><span class="p">,</span><span class="n">frame</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sed -i &#39;/</span><span class="si">{}</span><span class="s2">/d&#39; /gws/nopw/j04/nceo_geohazards_vol1/public/shared/frames/frames.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lics_mysql.sh&#39;</span><span class="p">)</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select polyid from polygs where polyid_name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">polyid</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">do_query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;delete from polygs2master where polyid=</span><span class="si">{}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;delete from polygs2bursts where polyid=</span><span class="si">{}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polyid</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="n">frame_workaround</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
    <span class="n">frame_workaround</span> <span class="o">=</span> <span class="n">frame_workaround</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;update polygs set polyid_name=&#39;</span><span class="si">{0}</span><span class="s2">&#39; where polyid_name=&#39;</span><span class="si">{1}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame_workaround</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;delete from polygs where polygs.polyid_name=&#39;</span><span class="si">{}</span><span class="s2">&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame_workaround</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">remove_bad_bursts</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">badbursts</span><span class="p">,</span> <span class="n">testonly</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="c1">#badbursts should be a list of bursts existing in the frame that should be removed</span>
    <span class="c1">#e.g. the list of missing bursts during the licsar_init_frame.sh script..</span>
    <span class="c1">#in testonly - it will only give text output, rather than really do something..</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bidtanxs_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">bursts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">badbursts</span><span class="p">:</span>
        <span class="n">bursts</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">generate_new_frame</span><span class="p">(</span><span class="n">bursts</span><span class="p">,</span> <span class="n">testonly</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;to remove the old frame, you should do:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fc.delete_frame(&#39;</span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
    <span class="c1">#delete_frame_commands(frame)</span>


<span class="k">def</span> <span class="nf">add_more_bursts</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">extrabursts</span><span class="p">,</span> <span class="n">testonly</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="c1">#extrabursts should be a list of bursts not existing in the frame, to be added there</span>
    <span class="c1">#in testonly - it will only give text output, rather than really do something..</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">get_bidtanxs_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">sqlout2list</span><span class="p">(</span><span class="n">bursts</span><span class="p">)</span>
    <span class="n">newbursts</span> <span class="o">=</span> <span class="n">bursts</span><span class="o">+</span><span class="n">extrabursts</span>
    <span class="c1">#remove duplicities</span>
    <span class="n">newbursts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">newbursts</span><span class="p">))</span>
    <span class="n">newbursts</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">generate_new_frame</span><span class="p">(</span><span class="n">newbursts</span><span class="p">,</span> <span class="n">testonly</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;to remove the old frame, you should do:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fc.delete_frame(&#39;</span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, COMET and CEMAC teams.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>